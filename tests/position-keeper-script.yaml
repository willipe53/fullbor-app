# Position Keeper API Test Script
# Tests the new start/stop endpoints functionality
# Run with: ./comprehensive-api-test.py position-keeper-script.yaml
# (Authentication and base URL are enabled by default)

defaults:
  headers:
    Content-Type: "application/json"
  timeout: 30

tests:
  # === POSITION KEEPER START/STOP TESTS ===

  # Step 1: Start the position keeper
  - name: "Start position keeper (first attempt)"
    request:
      method: POST
      url: "/position-keeper/start"
    expect:
      status: 201
      json:
        - path: "message"
          exists: true

  # Step 2: Try to start again (should return error - already pending)
  - name: "Start position keeper again (should handle gracefully)"
    request:
      method: POST
      url: "/position-keeper/start"
    expect:
      status: 409
      json:
        - path: "error"
          value: "Position Keeper is already pending"

  # Step 3: Stop the position keeper
  - name: "Stop position keeper"
    request:
      method: POST
      url: "/position-keeper/stop"
    expect:
      status: 200
      json:
        - path: "message"
          value: "Position Keeper instance stop initiated"

  # Step 4: Get position keeper status (should report valid EC2 state)
  - name: "Get position keeper status (should report valid EC2 state)"
    request:
      method: GET
      url: "/position-keeper/status"
    expect:
      status: 200
      json:
        - path: "ec2_state"
          matches: "^(pending|running|stopping|stopped)$"
        - path: "instance_id"
          exists: true
          type: "string"
